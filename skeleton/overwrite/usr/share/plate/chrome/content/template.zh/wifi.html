<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html;charset=utf8" />
<script type="text/javascript">

function system(input) {
	netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect"); 
	var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
	file.initWithPath("/usr/local/bin/jswrapper");
	var process = Components.classes["@mozilla.org/process/util;1"].createInstance(Components.interfaces.nsIProcess);
	process.init(file);
	var args = [input];
	process.run(false, args, 1);
}

function sleep(milliseconds) {
	var start = new Date().getTime();
	for (var i = 0; i < 1e7; i++) {
		if ((new Date().getTime() - start) > milliseconds) break;
	}
}

function $(id) { 
	return document.getElementById(id); 
}
function update_div(id, path) {
	netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect"); 
	var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
	file.initWithPath(path);

	var data = "";
	var fstream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
	var sstream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
	fstream.init(file, -1, 0, 0);
	sstream.init(fstream); 

	var str = sstream.read(4096);
	while (str.length > 0) {
		data += str;
		str = sstream.read(4096);
	}

	sstream.close();
	fstream.close();

	document.getElementById(id).innerHTML = data;
}
function check_enc(num) {
	var enc = $('ap-option').options[num].getAttribute('class').toString();
	$('enctype').value = enc;
	switch (enc) {
	case 'wifi-wep': // WEP
		$('passwd').disabled = false;
		break;
	case 'wifi-wpa': // WPA
		$('passwd').disabled = false;
		break;
	case 'wifi-hidden': // hidden node
		$('passwd').disabled = false;
		break;
	default: // none 
		$('passwd').disabled = true;
		break;
	}
}

function send_wifi() {

	var addr = $('ap-option').value;
	if ($('passwd') == null) { var passwd = ''; } 
	else { var passwd = '"' + $('passwd').value + '"'; }
	var enc = $('enctype').value;
	var nic = $('nic').value;
//	alert(addr + passwd + enc);
	system('/usr/local/bin/get_wifi ' + nic + ' ' + enc + ' ' + addr + ' ' + passwd);

}
</script>
</head>
<body  onload="system('/usr/local/bin/get_ssid'); sleep(50); update_div('ap-option', '/tmp/wifi.opt'); update_div('nic', '/tmp/wifi.dev'); $('passwd').disabled=true;">

<div style="margin: 20px auto; width: 400px;">
<h2 style="border-bottom: 1px gray solid;">無線網路設定</h2>

<label>網路卡: </label>
 <select id="nic"></select> 
 | <input type="button" value="重新掃描" onclick="system('/usr/local/bin/get_ssid'); sleep(50); update_div('ap-option', '/tmp/wifi.opt'); update_div('nic', '/tmp/wifi.dev'); $('passwd').disabled=true;" />

<p>選擇一個欲連線的網路：</p>

<select size="5" id="ap-option" style="width: 300px;">
</select>


<p>
<input type="hidden" id="enctype">
<label>密碼：</label> <input id="passwd" type="password" size="18" />
<input type="button" value="連線" onclick="send_wifi()" />
</p>
</div>

</body>
</html>
