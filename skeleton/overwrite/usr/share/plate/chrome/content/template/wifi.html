<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<script type="text/javascript" src="../jquery-1.3.2.js"></script>
<script type="text/javascript" src="../plate.js"></script>
<script type="text/javascript">

function system(input) {
	netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect"); 
	var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
	file.initWithPath("/usr/local/bin/jswrapper");
	var process = Components.classes["@mozilla.org/process/util;1"].createInstance(Components.interfaces.nsIProcess);
	process.init(file);
	var args = [input];
	process.run(false, args, 1);
}

function sleep(milliseconds) {
	var start = new Date().getTime();
	for (var i = 0; i < 1e7; i++) {
		if ((new Date().getTime() - start) > milliseconds) break;
	}
}

function update_div(id, path) {
	netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect"); 
	var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
	file.initWithPath(path);

	var data = "";
	var fstream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
	var sstream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
	fstream.init(file, -1, 0, 0);
	sstream.init(fstream); 

	var str = sstream.read(4096);
	while (str.length > 0) {
		data += str;
		str = sstream.read(4096);
	}

	sstream.close();
	fstream.close();

	document.getElementById(id).innerHTML = data;
}
function check_enc(num) {
	if (document.getElementById('wifi_connect')) {
	document.getElementById('wifi_connect').disabled = false;
	}
	var enc = document.getElementById('ap-option').options[num].getAttribute('class').toString();
	document.getElementById('enctype').value = enc;
	switch (enc) {
	case 'wifi-wep': // WEP
		document.getElementById('ssid').disabled = true;
		document.getElementById('passwd').disabled = false;
		document.getElementById('ssid-line').style.display = 'none';
		break;
	case 'wifi-wpa': // WPA
		document.getElementById('ssid').disabled = true;
		document.getElementById('passwd').disabled = false;
		document.getElementById('ssid-line').style.display = 'none';
		break;
	case 'wifi-wpa-hidden': // WPA-HIDDEN
		document.getElementById('passwd').disabled = false;
		document.getElementById('ssid').disabled = false;
		document.getElementById('ssid-line').style.display = 'block';
		break;
	case 'wifi-hidden': // hidden node
		document.getElementById('ssid').disabled = true;	
		document.getElementById('passwd').disabled = false;
		document.getElementById('ssid-line').style.display = 'block';
		break;
	default: // none 
		document.getElementById('ssid').disabled = true;		
		document.getElementById('passwd').disabled = true;
		document.getElementById('ssid-line').style.display = 'none';
		break;
	}
}

function send_wifi() {

	var addr = document.getElementById('ap-option').value;
	if (document.getElementById('ssid') != null) { addr = document.getElementById('ssid').value; }
	if (document.getElementById('passwd') == null) { var passwd = ''; } 
	else { var passwd = '"' + document.getElementById('passwd').value + '"'; }
	var enc = document.getElementById('enctype').value;
	var nic = document.getElementById('nic').value;
//	alert(addr + passwd + enc);
	system('/usr/local/bin/get_wifi ' + nic + ' ' + enc + ' ' + addr + ' ' + passwd);

}
</script>
</head>
<body  onload="system('/usr/local/bin/get_ssid'); sleep(50); update_div('ap-option', '/tmp/wifi.opt'); update_div('nic', '/tmp/wifi.dev'); document.getElementById('passwd').disabled=true;">

<div style="margin: 20px auto; width: 400px;">
<h2 style="border-bottom: 1px gray solid;">Wireless Network</h2>

<label>Network Device: </label>
 <select id="nic"></select> 
 | <input type="button" value="Refresh" onclick="system('/usr/local/bin/get_ssid'); sleep(50); update_div('ap-option', '/tmp/wifi.opt'); update_div('nic', '/tmp/wifi.dev'); document.getElementById('passwd').disabled=true;" />

<p>Choose a network you want to join: </p>

<select size="5" id="ap-option" style="width: 300px;">
</select>

<p>
<input type="hidden" id="enctype">
<div id="ssid-line" style="display: none;"><label>SSID:</label> <input id="ssid" type="text" size="18" disabled /><br /></div>
<label>Password:</label> <input id="passwd" type="password" size="18" disabled /><br />
<input type="button" value="Connect" onclick="send_wifi(); $(this).attr('disabled', 'disabled'); $(this).attr('value', 'Done.');" />
</p>
</div>

</body>
</html>
