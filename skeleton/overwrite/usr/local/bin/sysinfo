#!/usr/bin/perl

open (F, ">/tmp/sysinfo");
open (FS, ">/tmp/sysinfo-s");

#print F "Time: ", `LC_ALL=C date +%a\\ %I:%M\\ %p`, "<br />\n";
chomp($time_s = `LC_ALL=C date +%I:%M\\ %p`);
chomp($time = `LC_ALL=C date +%R`);
chomp($date = `LC_ALL=C date +%b%_d\\ \\(%a\\)`);

if (`ifconfig | grep -v 127.* | grep "inet addr"`) { # online
$netstat = "Online"; 
$iw = `iwconfig`;
$ssid = $1 if $iw =~ /ESSID:"(.*?)"/;
$quality = $1 if $iw =~ /Link Quality=(.*?)\s/;
$str = sprintf "%.2d", ((eval $quality)*100);

	if ($str != '') {
		if ($str >= 60) { $net_icon = "wireless-signal-excellent.png"; } 
		elsif ($str <= 30) { $net_icon = "wireless-signal-okay.png"; } 
		else { $net_icon = "wireless-signal-good.png"; }
	} else { $net_icon = "wireless-signal-excellent.png"; } 

if ($ssid ne '' && $str ne '') {
	$netstat .= " ($ssid - $str%)";
}
} 
elsif ( -e "/tmp/netstat.tmp" && `ps | grep dhclient`) { 
$netstat = "Connecting"; $net_icon = "network-idle.png"; } 
else { $netstat = "Offline"; $net_icon = "edit-delete.png"; } 

#print F "Network: $netstat <br />\n";

$info = `cat /proc/acpi/battery/*/state`;

if ( $info ne '' ) {

	$batstat = "Battery: ";
	if ($info =~ /discharging/) {
	$r = $1 if $info =~ /present rate:\s+(\d+)\s/;
	$c = $1 if $info =~ /remaining capacity:\s+(\d+)\s/;
	
		if ($r != 0) {
		$h = sprintf "%d", $c/$r;
		$m = sprintf "%.2d", 60*$c/$r-$h*60;
		$batstat .= "$h:$m";
		}

	} else {
	$batstat .= "Charging"; 
	}
	
	$status = '';
	for (`cat /sys/bus/acpi/drivers/battery/*/power_supply/*/uevent`) {
	$full = $1 if /CHARGE_FULL=(.*)$/;
	$now = $1 if /CHARGE_NOW=(.*)$/;
	#$status = 'Charging - ' if /SUPPLY_STATUS=Charging/;
	}

	if ($full) {
	$bat_percent = $now / $full * 100;
	$batstat .= sprintf " (%s%.2d%) <br />\n", $status, $bat_percent;
	} else {
		for (`cat /sys/bus/acpi/drivers/battery/*/power_supply/*/uevent`) {
		$full = $1 if /ENERGY_FULL=(.*)$/;
		$now = $1 if /ENERGY_NOW=(.*)$/;
		}

	}

	$bat_percent = $now / $full * 100;
	$batstat .= sprintf " (%s%.2d%) <br />\n", $status, $bat_percent if ($full);

	if ( $batstat =~ /Charging/) { $bat_icon = "battery-charging.png"; }  
	
	elsif ($bat_percent ne '') {

	if ($bat_percent >= 75) { $bat_icon = "battery-full.png"; }
	elsif ($bat_percent >= 50 && $bat_percent < 75) { $bat_icon = "battery-good.png"; }
	elsif ($bat_percent >= 25 && $bat_percent < 50) { $bat_icon = "battery-caution.png"; }
	else { $bat_icon = "battery-low.png"; }
	
	} else { $bat_icon = "battery-full.png"; }

}


print F<<EOF;

<div style="float: left; width: 160px; margin-right: 10px;">
<img src="image/$net_icon" style="margin-right: 60px;" />
<span>Network: $netstat</span>
</div>

<div style="float: left; width: 160px; margin-right: 25px;">
<img src="image/$bat_icon" style="margin-right: 60px;" />
<span>$batstat</span>
</div>

<div style="float: left; width: 70px;">
<h3>$time</h3>
<span>$date</span>
</div>
EOF

print FS "$netstat | $time_s | $batstat\n";
