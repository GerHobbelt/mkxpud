#!/bin/sh
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
export DISPLAY=:0
export GTK_IM_MODULE="scim"

	/bin/mount -t sysfs none /sys -onodev,noexec,nosuid
	/bin/mount -t proc none /proc -onodev,noexec,nosuid
	ln -sf /proc/mounts /etc/mtab

	/usr/sbin/915resolution 32 1024 600 24
	/usr/sbin/915resolution -l > /tmp/915
	if grep -q '1024x600' /tmp/915; then
		RES=1024x600x24
	else
		RES=1024x768x24
	fi

	for x in $(cat /proc/cmdline); do
		case $x in
			screen=*)
				export RES=${x#screen=}
			;;
			lang=*)
				export UILANG=${x#lang=}
			;;
			kmap=*)
				export KEYMAP=${x#kmap=}
			;;
		esac
	done 

	# keymap
	if [ ! -z $KEYMAP ] && [ -e /usr/share/keymap/$KEYMAP.kmap ]; then 
		loadkmap < /usr/share/keymap/$KEYMAP.kmap
	fi

	# plate locale
	PLATE=/usr/share/plate/chrome/content
	if [ ! -z $UILANG ] && [ -e $PLATE/template.$UILANG ]; then 
		UILANG=	$UILANG
	else
		UILANG=en
	fi
	ln -s $PLATE/index.$UILANG.html $PLATE/index.html
	ln -s $PLATE/template.$UILANG $PLATE/template

	# init hook
	find /etc/init.d/ -type f -exec {} \; 
	
	# X server
	/usr/local/bin/Xvesa :0 -ac -shadow -screen $RES -br -mouse mouse,/dev/input/mice &
	/bin/sleep 0.1
	
	# count boot time
	#TIME=`/bin/cat /proc/uptime | /bin/cut -d' ' -f 1` 
	#/bin/sed -e s/xPUD.*9/"xPUD 0.9<br \/>Boot time: $TIME sec"/g /usr/share/plate/chrome/content/template/home.html.bak > /usr/share/plate/chrome/content/template/home.html 
	
	# start plate UI
	/usr/bin/firefox -app /usr/share/plate/application.ini &
#	touch /tmp/sysinfo
	/sbin/session &
	/bin/sh
