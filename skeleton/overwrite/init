#!/bin/sh
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
export DISPLAY=:0
export GTK_IM_MODULE="scim"

	/bin/mount -t sysfs none /sys -onodev,noexec,nosuid
	/bin/mount -t proc none /proc -onodev,noexec,nosuid
	ln -sf /proc/mounts /etc/mtab

	for x in $(cat /proc/cmdline); do
		case $x in
			screen=*)
				export RES=${x#screen=}
			;;
			lang=*)
				export UILANG=${x#lang=}
			;;
			kmap=*)
				export KEYMAP=${x#kmap=}
			;;
		esac
	done 

	# keymap
	if [ ! -z $KEYMAP ] && [ -e /usr/share/keymap/$KEYMAP.kmap ]; then 
		loadkmap < /usr/share/keymap/$KEYMAP.kmap
	fi

	# plate locale
	PLATE=/usr/share/plate/chrome/content
	if [ ! -z $UILANG ] && [ -e $PLATE/index.$UILANG.html ]; then 
		UILANG=$UILANG
	else
		UILANG=en
	fi
	/bin/sed -e s/index.*html/"index.$UILANG.html"/g $PLATE/main.default > $PLATE/main.xul 

	# init hook
	find /etc/init.d/ -type f -exec {} \; 
	
	echo "Video resolution script started"
	# GET video modes and screen resolution
	echo "Writing logs"
	/usr/sbin/ddcprobe > /tmp/ddcprobe.log
	/usr/sbin/915resolution -l &> /tmp/915res.log
	/usr/local/bin/Xvesa -listmodes 2> /tmp/xvmodes.log
	
	# FIND correct resolution
	echo "Try to find panel size"
	if [ -z $RES ]; then
		echo "Video mode was not set on boot, ddcprobe"
		# if ddcprobe failed - try again
		if grep edidfail /tmp/ddcprobe.log ; then
			echo "edid fail, trying again"
			sleep 1
			/usr/sbin/ddcprobe > /tmp/ddcprobe.log
		fi
		# get panel size from ddcprobe
		VMODE=`grep dtiming /tmp/ddcprobe.log | cut -d " " -f 2`
		# if panel size was found - set the screen resolution
		if [ ! -z $VMODE ]; then
			echo "ddcprobe dtiming found "$VMODE
			VRES=`echo $VMODE | cut -d @ -f 1`
			VRES=`echo $VRES"x24"`
		else # if failed again - set default resolution
			echo "ddcprobe failed again"
			VRES=1024x600x24
		fi
	else
		# be sure to set resolution - it will be used in patching
		echo "Resolution was set on boot"
		VRES=$RES	
	fi
	echo "Got resolution "$VRES
	
	# PATCH resolution if needed
	echo "Will patch if needed"
	# if video resolution is not in Xvesa list and chip is supported by 915resolution
	if ! grep $VRES /tmp/xvmodes.log && grep Mode /tmp/915res.log ; then
		echo "Trying to patch..."
		# try to patch needed video mode
		/usr/sbin/915resolution 38 `echo ${VRES/x/ }`
		# using original resolution setting method
		/usr/sbin/915resolution -l > /tmp/915.tmp
		# if resolution set successfull
		TMPRES=`echo $VRES | cut -d x -f 1,2`
		if ! grep -q $TMPRES /tmp/915.tmp ; then
			echo "Patching failed, back to default resolution"
			VRES=1024x768x24
		else
			echo "Successfully patched"
		fi
	else
		echo "Patching is not needed/supported"
		# if resolution was not set in earlier step - set it to default
		if [ -z $VRES ]; then
			VRES=1024x768x24
		fi
	fi
	
	# SET resolution
	export RES=$VRES
	echo "Resolution will be set as "$RES
	
	# start X server
	/usr/local/bin/Xvesa -ac -shadow dpms +extension Composite -screen $RES -br -mouse /dev/input/mice,5 &
	/bin/sleep 0.1
	
	# start plate
	/usr/bin/firefox -app /usr/share/plate/application.ini &
	/sbin/session &
	/usr/sbin/acpid &
	/bin/sh
